ARG NODE_VERSION=24.13.1

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ NODE STAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FROM ubuntu:latest AS node

# ğŸ› ï¸ Set noninteractive frontend
ENV DEBIAN_FRONTEND=noninteractive

ARG NODE_VERSION

RUN \
  apt-get update || (sleep 10 && apt-get update) || (sleep 20 && apt-get update) \
  && apt-get install -y --no-install-recommends ca-certificates curl xz-utils \
  && apt-get clean \
  && rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/* /tmp/* /var/tmp/* \
  && rm -rf /usr/share/doc/* /usr/share/man/* /usr/share/info/* /usr/share/lintian/* /usr/share/locale/* \
  && \
  set -x \
  && DPKG_ARCH=$(dpkg --print-architecture) \
  && case "${DPKG_ARCH}" in \
  amd64) NODE_ARCH="x64" ;; \
  *) NODE_ARCH="${DPKG_ARCH}" ;; \
  esac \
  && curl -fsSL "https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-linux-${NODE_ARCH}.tar.xz" -o /tmp/node.tar.xz \
  && mkdir -p /opt/node \
  && tar -xJf /tmp/node.tar.xz -C /opt/node --strip-components=1 --no-same-owner \
  && rm -f /tmp/node.tar.xz \
  && rm -rf /opt/node/share/doc /opt/node/share/man /opt/node/share/systemtap \
  && rm -rf /tmp/* /var/tmp/* \
  && export PATH=/opt/node/bin:$PATH

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RELEASE STAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FROM ubuntu:latest AS release

# ğŸ› ï¸ Set noninteractive frontend
ENV DEBIAN_FRONTEND=noninteractive

# Copy Node.js from the node stage
COPY --from=node /opt/node /opt/node

# Set environment variables for Node.js
ENV PATH=/usr/local/bin:/opt/node/bin:$PATH
ENV npm_config_prefix=/usr/local

# ---- Build arguments injected by CI ----
ARG VERSION
ARG VCS_REF
ARG BUILD_DATE

# ---- OCI standard labels (https://opencontainers.org/) ----
LABEL org.opencontainers.image.title="matterbridge:24-ubuntu-slim" \
  org.opencontainers.image.description="Ubuntu 24.04.3 LTS (noble) with Node.js 24 from nodejs.org" \
  org.opencontainers.image.version=$VERSION \
  org.opencontainers.image.revision=$VCS_REF \
  org.opencontainers.image.source="git+https://github.com/Luligu/matterbridge.git" \
  org.opencontainers.image.url="https://matterbridge.io" \
  org.opencontainers.image.documentation="https://matterbridge.io/README.html" \
  org.opencontainers.image.licenses="Apache-2.0" \
  org.opencontainers.image.authors="Luligu <https://github.com/Luligu>" \
  org.opencontainers.image.created=$BUILD_DATE

RUN \
  apt-get update || (sleep 10 && apt-get update) || (sleep 20 && apt-get update) \
  && apt-get install -y --no-install-recommends ca-certificates \
  && apt-get clean \
  && rm -rf /var/lib/apt/lists/* /var/cache/apt/archives/* /tmp/* /var/tmp/* \
  && rm -rf /usr/share/doc/* /usr/share/man/* /usr/share/info/* /usr/share/lintian/* /usr/share/locale/*

# Copy and execute the entrypoint script
COPY ./docker/entrypoint.24-ubuntu-slim.sh ./
RUN chmod +x ./entrypoint.24-ubuntu-slim.sh
ENTRYPOINT ["./entrypoint.24-ubuntu-slim.sh"]
CMD ["bash"]
